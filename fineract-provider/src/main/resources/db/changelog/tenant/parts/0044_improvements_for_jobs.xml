<?xml version="1.0" encoding="UTF-8"?>
<!--

    Licensed to the Apache Software Foundation (ASF) under one
    or more contributor license agreements. See the NOTICE file
    distributed with this work for additional information
    regarding copyright ownership. The ASF licenses this file
    to you under the Apache License, Version 2.0 (the
    "License"); you may not use this file except in compliance
    with the License. You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, either express or implied. See the License for the
    specific language governing permissions and limitations
    under the License.

-->
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.1.xsd">
    <!--
        comment: This change set is to update the job table to add a new column called 'order' to store the order of the jobs to be executed.
    -->
    <changeSet author="fineract" id="1">
        <addColumn tableName="job">
            <column name="execution_order" type="INT" defaultValueComputed="NULL"/>
        </addColumn>
    </changeSet>

    <!--
        comment: This change set is to set the order for jobs to be executed.
    -->
    <changeSet author="fineract" id="2">
        <sql>
            UPDATE job SET display_name = '1.Apply Holidays To Loans', execution_order = 1 WHERE name = 'Apply Holidays To Loans'
        </sql>
        <sql>
            UPDATE job SET display_name = '2.Apply penalty to overdue loans', execution_order = 2 WHERE name = 'Apply penalty to overdue loans'
        </sql>
        <sql>
            UPDATE job SET display_name = '3.Update Non Performing Assets', execution_order = 3 WHERE name = 'Update Non Performing Assets'
        </sql>
        <sql>
            UPDATE job SET display_name = '4.Update Loan Arrears Ageing', execution_order = 4 WHERE name = 'Update Loan Arrears Ageing'
        </sql>
        <sql>
            UPDATE job SET display_name = '5.Recalculate Interest For Loans', execution_order = 5 WHERE name = 'Recalculate Interest For Loans'
        </sql>
        <sql>
            UPDATE job SET display_name = '6.Add Accrual Transactions', execution_order = 6 WHERE name = 'Add Accrual Transactions'
        </sql>
        <sql>
            UPDATE job SET display_name = '7.Add Accrual Transactions For Loans With Income Posted As Transactions', execution_order = 7 WHERE name = 'Add Accrual Transactions For Loans With Income Posted As Transactions'
        </sql>
        <sql>
            UPDATE job SET display_name = '8.Add Periodic Accrual Transactions', execution_order = 8 WHERE name = 'Add Periodic Accrual Transactions'
        </sql>
        <sql>
            UPDATE job SET display_name = '9.Generate Loan Loss Provisioning', execution_order = 9 WHERE name = 'Generate Loan Loss Provisioning'
        </sql>
        <sql>
            UPDATE job SET display_name = '10.Update Accounting Running Balances', execution_order = 10 WHERE name = 'Update Accounting Running Balances'
        </sql>
        <sql>
            UPDATE job SET display_name = '11.Update Trial Balance Details', execution_order = 11 WHERE name = 'Update Trial Balance Details'
        </sql>
    </changeSet>

    <!--
        comment: this change set is to set as inactive the job 'Apply Annual Fee For Savings' and delete the job run history for this job.
    -->
    <changeSet author="fineract" id="3">
        <sql>
            DELETE FROM job_run_history WHERE job_id IN (SELECT id FROM job WHERE name IN ('Apply Annual Fee For Savings'))
        </sql>
        <sql>
            UPDATE job SET is_active = 0 WHERE name = 'Apply Annual Fee For Savings'
        </sql>
    </changeSet>

    <!--
        comment: this change set is to set as inactive the job 'Execute All Dirty Jobs' and delete the job run history for this job.
    -->
    <changeSet author="fineract" id="4">
        <sql>
            DELETE FROM job_run_history WHERE job_id IN (SELECT id FROM job WHERE name IN ('Execute All Dirty Jobs'))
        </sql>
        <sql>
            UPDATE job SET is_active = 0 WHERE name = 'Execute All Dirty Jobs'
        </sql>
    </changeSet>

    <!--
        comment: this change set is to set as inactive the job 'Execute Email' and delete the job run history for this job.
    -->
    <changeSet author="fineract" id="5">
        <sql>
            DELETE FROM job_run_history WHERE job_id IN (SELECT id FROM job WHERE name IN ('Execute Email'))
        </sql>
        <sql>
            UPDATE job SET is_active = 0 WHERE name = 'Execute Email'
        </sql>
    </changeSet>

    <!--
        comment: this change set is to set as inactive the job 'Execute Report Mailing Jobs' and delete the job run history for this job.
    -->
    <changeSet author="fineract" id="6">
        <sql>
            DELETE FROM job_run_history WHERE job_id IN (SELECT id FROM job WHERE name IN ('Execute Report Mailing Jobs'))
        </sql>
        <sql>
            UPDATE job SET is_active = 0 WHERE name = 'Execute Report Mailing Jobs'
        </sql>
    </changeSet>

    <!--
        comment: this change set is to set as inactive the job 'Execute Standing Instruction' and delete the job run history for this job.
    -->
    <changeSet author="fineract" id="7">
        <sql>
            DELETE FROM job_run_history WHERE job_id IN (SELECT id FROM job WHERE name IN ('Execute Standing Instruction'))
        </sql>
        <sql>
            UPDATE job SET is_active = 0 WHERE name = 'Execute Standing Instruction'
        </sql>
    </changeSet>

    <!--
        comment: this change set is to set as inactive the job 'Generate AdhocClient Schedule' and delete the job run history for this job.
    -->
    <changeSet author="fineract" id="8">
        <sql>
            DELETE FROM job_run_history WHERE job_id IN (SELECT id FROM job WHERE name IN ('Generate AdhocClient Schedule'))
        </sql>
        <sql>
            UPDATE job SET is_active = 0 WHERE name = 'Generate AdhocClient Schedule'
        </sql>
    </changeSet>

    <!--
        comment: this change set is to set as inactive the job 'Generate Mandatory Savings Schedule' and delete the job run history for this job.
    -->
    <changeSet author="fineract" id="9">
        <sql>
            DELETE FROM job_run_history WHERE job_id IN (SELECT id FROM job WHERE name IN ('Generate Mandatory Savings Schedule'))
        </sql>
        <sql>
            UPDATE job SET is_active = 0 WHERE name = 'Generate Mandatory Savings Schedule'
        </sql>
    </changeSet>

    <!--
        comment: this change set is to set as inactive the job 'Get Delivery Reports from SMS Gateway' and delete the job run history for this job.
    -->
    <changeSet author="fineract" id="10">
        <sql>
            DELETE FROM job_run_history WHERE job_id IN (SELECT id FROM job WHERE name IN ('Get Delivery Reports from SMS Gateway'))
        </sql>
        <sql>
            UPDATE job SET is_active = 0 WHERE name = 'Get Delivery Reports from SMS Gateway'
        </sql>
    </changeSet>

    <!--
        comment: this change set is to set as inactive the job 'Increase Business Date by 1 day' and delete the job run history for this job.
    -->
    <changeSet author="fineract" id="11">
        <sql>
            DELETE FROM job_run_history WHERE job_id IN (SELECT id FROM job WHERE name IN ('Increase Business Date by 1 day'))
        </sql>
        <sql>
            UPDATE job SET is_active = 0 WHERE name = 'Increase Business Date by 1 day'
        </sql>
    </changeSet>

    <!--
        comment: this change set is to set as inactive the job 'Increase COB Date by 1 day' and delete the job run history for this job.
    -->
    <changeSet author="fineract" id="12">
        <sql>
            DELETE FROM job_run_history WHERE job_id IN (SELECT id FROM job WHERE name IN ('Increase COB Date by 1 day'))
        </sql>
        <sql>
            UPDATE job SET is_active = 0 WHERE name = 'Increase COB Date by 1 day'
        </sql>
    </changeSet>

    <!--
        comment: this change set is to set as inactive the job 'Pay Due Savings Charges' and delete the job run history for this job.
    -->
    <changeSet author="fineract" id="13">
        <sql>
            DELETE FROM job_run_history WHERE job_id IN (SELECT id FROM job WHERE name IN ('Pay Due Savings Charges'))
        </sql>
        <sql>
            UPDATE job SET is_active = 0 WHERE name = 'Pay Due Savings Charges'
        </sql>
    </changeSet>

    <!--
        comment: this change set is to set as inactive the job 'Post Dividends For Shares' and delete the job run history for this job.
    -->
    <changeSet author="fineract" id="14">
        <sql>
            DELETE FROM job_run_history WHERE job_id IN (SELECT id FROM job WHERE name IN ('Post Dividends For Shares'))
        </sql>
        <sql>
            UPDATE job SET is_active = 0 WHERE name = 'Post Dividends For Shares'
        </sql>
    </changeSet>

    <!--
        comment: this change set is to set as inactive the job 'Post Interest For Savings' and delete the job run history for this job.
    -->
    <changeSet author="fineract" id="15">
        <sql>
            DELETE FROM job_run_history WHERE job_id IN (SELECT id FROM job WHERE name IN ('Post Interest For Savings'))
        </sql>
        <sql>
            UPDATE job SET is_active = 0 WHERE name = 'Post Interest For Savings'
        </sql>
    </changeSet>

    <!--
        comment: this change set is to set as inactive the job 'Send Messages to SMS Gateway' and delete the job run history for this job.
    -->
    <changeSet author="fineract" id="16">
        <sql>
            DELETE FROM job_run_history WHERE job_id IN (SELECT id FROM job WHERE name IN ('Send Messages to SMS Gateway'))
        </sql>
        <sql>
            UPDATE job SET is_active = 0 WHERE name = 'Send Messages to SMS Gateway'
        </sql>
    </changeSet>

    <!--
        comment: this change set is to set as inactive the job 'Send Messages to SMS Gateway' and delete the job run history for this job.
    -->
    <changeSet author="fineract" id="17">
        <sql>
            DELETE FROM job_run_history WHERE job_id IN (SELECT id FROM job WHERE name IN ('Transfer Fee For Loans From Savings'))
        </sql>
        <sql>
            UPDATE job SET is_active = 0 WHERE name = 'Transfer Fee For Loans From Savings'
        </sql>
    </changeSet>

    <!--
        comment: this change set is to set as inactive the job 'Transfer Interest To Savings' and delete the job run history for this job.
    -->
    <changeSet author="fineract" id="18">
        <sql>
            DELETE FROM job_run_history WHERE job_id IN (SELECT id FROM job WHERE name IN ('Transfer Interest To Savings'))
        </sql>
        <sql>
            UPDATE job SET is_active = 0 WHERE name = 'Transfer Interest To Savings'
        </sql>
    </changeSet>

    <!--
        comment: this change set is to set as inactive the job 'Update Deposit Accounts Maturity details' and delete the job run history for this job.
    -->
    <changeSet author="fineract" id="19">
        <sql>
            DELETE FROM job_run_history WHERE job_id IN (SELECT id FROM job WHERE name IN ('Update Deposit Accounts Maturity details'))
        </sql>
        <sql>
            UPDATE job SET is_active = 0 WHERE name = 'Update Deposit Accounts Maturity details'
        </sql>
    </changeSet>

    <!--
        comment: this change set is to set as inactive the job 'Update Email Outbound with campaign message' and delete the job run history for this job.
    -->
    <changeSet author="fineract" id="20">
        <sql>
            DELETE FROM job_run_history WHERE job_id IN (SELECT id FROM job WHERE name IN ('Update Email Outbound with campaign message'))
        </sql>
        <sql>
            UPDATE job SET is_active = 0 WHERE name = 'Update Email Outbound with campaign message'
        </sql>
    </changeSet>

    <!--
        comment: this change set is to set as inactive the job 'Update Savings Dormant Accounts' and delete the job run history for this job.
    -->
    <changeSet author="fineract" id="21">
        <sql>
            DELETE FROM job_run_history WHERE job_id IN (SELECT id FROM job WHERE name IN ('Update Savings Dormant Accounts'))
        </sql>
        <sql>
            UPDATE job SET is_active = 0 WHERE name = 'Update Savings Dormant Accounts'
        </sql>
    </changeSet>

    <!--
        comment: this change set is to set as inactive the job 'Update SMS Outbound with Campaign Message' and delete the job run history for this job.
    -->
    <changeSet author="fineract" id="22">
        <sql>
            DELETE FROM job_run_history WHERE job_id IN (SELECT id FROM job WHERE name IN ('Update SMS Outbound with Campaign Message'))
        </sql>
        <sql>
            UPDATE job SET is_active = 0 WHERE name = 'Update SMS Outbound with Campaign Message'
        </sql>
    </changeSet>

    <!--
        comment: add a constraint in job_run_history table to make sure that the job_id is not null
    -->
    <changeSet author="fineract" id="23">
        <preConditions onFail="MARK_RAN">
            <indexExists indexName="scheduledjobsFK" />
        </preConditions>
        <dropIndex tableName="job_run_history" indexName="scheduledjobsFK" />
    </changeSet>

    <changeSet author="fineract" id="24">
        <addForeignKeyConstraint baseColumnNames="job_id"
                                 baseTableName="job_run_history"
                                 constraintName="scheduledjobsFK" deferrable="false" initiallyDeferred="false"
                                 onDelete="RESTRICT" onUpdate="RESTRICT" referencedColumnNames="id"
                                 referencedTableName="job" validate="true"/>
    </changeSet>

    <changeSet author="fineract" id="25">
        <sql>
            UPDATE m_causal_process_mapping SET currency_int_code = 484 WHERE currency_int_code = 320
        </sql>
    </changeSet>

    <changeSet author="fineract" id="26">
        <sql>
            UPDATE m_code_causal SET currency_int_code = 484 WHERE currency_int_code = 320
        </sql>
    </changeSet>

</databaseChangeLog>
