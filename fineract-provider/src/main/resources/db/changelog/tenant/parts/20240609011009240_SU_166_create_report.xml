<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.1.xsd">

    <changeSet id="1" author="fineract">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM stretchy_parameter WHERE parameter_name = 'mandatoryNoveltyCode'
            </sqlCheck>
        </preConditions>
        <sql>
            INSERT INTO stretchy_parameter
            (parameter_name, parameter_variable, parameter_label, "parameter_displayType", "parameter_FormatType", parameter_default, special, "selectOne", "selectAll", parameter_sql, parent_id)
            VALUES('mandatoryNoveltyCode', 'mandatoryNoveltyCode', ' Código de la novedad', 'select', 'text', '', NULL, NULL, 'Y', 'select id , name from m_insurance_incidents where is_mandatory = true', NULL);
        </sql>
    </changeSet>



    <changeSet id="2" author="fineract">

        <insert tableName="STRETCHY_REPORT">
            <column name="REPORT_NAME" value="Novedades de Seguros Obligatorios"/>
            <column name="REPORT_SQL">
                <![CDATA[
       SELECT '800139398-6'                                                     AS "Nit de empresa",
       minn.novelty_date                                                 AS "Fecha de la novedad",
       mii.incident_type                                                 AS "Tipo de novedad",
       mii.name                                                          AS "Código de la novedad",
       CASE
           WHEN c.legal_form_enum = 2 THEN 'NIT'
           ELSE 'Cédula'
           END                                                           AS "Tipo de documento",
       COALESCE(cce."NIT", ccp."Cedula")                                 AS "Número de documento de identidad",
       CASE
           WHEN c.legal_form_enum = 2 THEN c.fullname
           ELSE c.firstname
           END                                                           AS "Nombre del cliente de la novedad",
       c.lastname                                                        AS "Apellidos del cliente de la novedad",
       mc.insurance_code                                                 AS "Código del seguro obligatorio",
       (COALESCE(insurance_chg.amount, 0) + COALESCE(vat_chg.amount, 0)) AS "Valor total del seguro",
       COALESCE(insurance_chg.amount, 0)                                 AS "Valor de la base del seguro",
       COALESCE(vat_chg.amount, 0)                                       AS "Valor del iva del seguro",
       l.account_no                                                      AS "Número del crédito",
       mc.insurance_company                                              AS "Nit aseguradora"
FROM m_insurance_novelty_news minn

         JOIN m_insurance_incidents mii ON minn.novelty_id = mii.id
         JOIN
     m_loan l ON minn.loan_id = l.id

         JOIN m_client c on l.client_id = c.id
         JOIN m_loan_charge mlc ON mlc.loan_id = l.id
         JOIN m_charge mc ON mc.id = mlc.charge_id
         LEFT JOIN campos_cliente_empresas cce ON cce.client_id = c.id
         LEFT JOIN campos_cliente_persona ccp ON ccp.client_id = c.id

         JOIN (SELECT mlic.amount, mlic.loan_charge_id, mlrs.installment, mlrs.loan_id
               FROM m_loan_installment_charge mlic
                        JOIN m_loan_repayment_schedule mlrs
                             ON mlrs.id = mlic.loan_schedule_id AND mlrs.installment = 1) insurance_chg
              ON insurance_chg.loan_charge_id = mlc.id AND insurance_chg.loan_id = l.id
         LEFT JOIN (SELECT mlic.amount, mc2.parent_charge_id, mlrs.installment, mlrs.loan_id
                    FROM m_loan_installment_charge mlic
                             JOIN m_loan_repayment_schedule mlrs
                                  ON mlrs.id = mlic.loan_schedule_id AND mlrs.installment = 1
                             JOIN m_loan_charge mlc2 ON mlc2.id = mlic.loan_charge_id
                             JOIN m_charge mc2 ON mc2.id = mlc2.charge_id AND mc2.charge_calculation_enum = 342) vat_chg
                   ON vat_chg.parent_charge_id = mc.id AND vat_chg.loan_id = l.id
WHERE mc.charge_calculation_enum IN (468, 575, 231)
  AND minn.novelty_date BETWEEN '${startDate}' AND '${endDate}'
  AND (mc.insurance_company = '${insurerNit}' OR '${insurerNit}' = '-1')
  AND (mc.insurance_code = '${mandatoryInsuranceCode}' OR '${mandatoryInsuranceCode}' = '-1')
  AND (minn.novelty_id = '${mandatoryNoveltyCode}' OR '${mandatoryNoveltyCode}' = '-1')
ORDER BY minn.novelty_date DESC

        ]]>
            </column>
            <column name="report_type" value="Table"/>
            <column name="report_category" value="Loan"/>
            <column name="description" value="Reporte de Novedades de Seguros Obligatorios"/>
            <column name="core_report" value="false"/>
            <column name="use_report" value="true"/>
        </insert>

        <insert tableName="stretchy_report_parameter">
            <column name="report_id" valueComputed="(select id from stretchy_report where report_name = 'Novedades de Seguros Obligatorios')"/>
            <column name="parameter_id" valueComputed="(select id from stretchy_parameter where parameter_variable = 'startDate')"/>
            <column name="report_parameter_name" value="startDate"/>
            <column name="mandatory_parameter" value="true"/>
        </insert>
        <insert tableName="stretchy_report_parameter">
            <column name="report_id" valueComputed="(select id from stretchy_report where report_name = 'Novedades de Seguros Obligatorios')"/>
            <column name="parameter_id" valueComputed="(select id from stretchy_parameter where parameter_variable = 'endDate')"/>
            <column name="report_parameter_name" value="endDate"/>
            <column name="mandatory_parameter" value="true"/>
        </insert>
        <insert tableName="stretchy_report_parameter">
            <column name="report_id" valueComputed="(select id from stretchy_report where report_name = 'Novedades de Seguros Obligatorios')"/>
            <column name="parameter_id" valueComputed="(select id from stretchy_parameter where parameter_variable = 'insurerNit')"/>
            <column name="report_parameter_name" value="insurerNit"/>
        </insert>
        <insert tableName="stretchy_report_parameter">
            <column name="report_id" valueComputed="(select id from stretchy_report where report_name = 'Novedades de Seguros Obligatorios')"/>
            <column name="parameter_id" valueComputed="(select id from stretchy_parameter where parameter_variable = 'mandatoryInsuranceCode')"/>
            <column name="report_parameter_name" value="mandatoryInsuranceCode"/>
        </insert>
        <insert tableName="stretchy_report_parameter">
            <column name="report_id" valueComputed="(select id from stretchy_report where report_name = 'Novedades de Seguros Obligatorios')"/>
            <column name="parameter_id" valueComputed="(select id from stretchy_parameter where parameter_variable = 'mandatoryNoveltyCode')"/>
            <column name="report_parameter_name" value="mandatoryNoveltyCode"/>
        </insert>
    </changeSet>

</databaseChangeLog>
