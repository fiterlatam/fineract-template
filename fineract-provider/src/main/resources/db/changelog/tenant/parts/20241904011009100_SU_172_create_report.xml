<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.1.xsd">
    <changeSet id="1" author="fineract">


        <delete tableName="stretchy_report_parameter">
            <where>report_id = (select id from stretchy_report where report_name = 'Ventas de Seguros y Asistencias
                Voluntarias')
            </where>
        </delete>
        <delete tableName="STRETCHY_REPORT">
            <where>REPORT_NAME='Ventas de Seguros y Asistencias Voluntarias'</where>
        </delete>

        <update tableName="stretchy_report">
            <column name="report_sql">
                <![CDATA[
                    SELECT cce."NIT" AS "Nit de empresa",
                    TO_CHAR(ml.submittedon_date, 'DD/MM/YYYY') AS "Fecha de creación del crédito",
                    CASE
                        WHEN c.legal_form_enum = 2 THEN c.fullname
                        ELSE c.firstname
                    END AS "Nombre del cliente",
                    c.lastname AS "Apellidos del cliente",
                    TO_CHAR(c.date_of_birth, 'DD/MM/YYYY') AS "Fecha de Nacimiento del cliente",
                    ml.account_no AS "Número del crédito",
                    ml.term_frequency AS "Plazo del crédito",
                    ml.principal_amount AS "Valor del crédito (capital inicial)",
                    (COALESCE(insurance_chg.amount, 0) + COALESCE(vat_chg.amount, 0)) AS "Valor mensual del seguro",
                    COALESCE(insurance_chg.amount, 0) AS "Valor de la base del seguro",
                    COALESCE(vat_chg.amount, 0) AS "Valor del IVA del seguro",
                    mc.insurance_code AS "Código del seguro obligatorio",
                    mc.insurance_company AS "Nit aseguradora", mc.charge_calculation_enum
                FROM m_client c
                JOIN m_loan ml ON ml.client_id = c.id
                JOIN m_loan_charge mlc ON mlc.loan_id = ml.id
                JOIN m_charge mc ON mc.id = mlc.charge_id
                LEFT JOIN campos_cliente_empresas cce ON cce.client_id = c.id
                JOIN (SELECT distinct on (mlc2.id) mlic.amount, mlic.loan_charge_id, mlrs.installment, mlrs.loan_id
                      FROM m_loan_installment_charge mlic
                      JOIN m_loan_repayment_schedule mlrs ON mlrs.id = mlic.loan_schedule_id
                        JOIN m_loan_charge mlc2 on mlc2.id = mlic.loan_charge_id
                         where mlc2.charge_calculation_enum IN (468, 575, 231)
                        order by mlc2.id, mlrs.installment) insurance_chg
                ON insurance_chg.loan_charge_id = mlc.id AND insurance_chg.loan_id = ml.id
                LEFT JOIN (SELECT distinct on (mlc2.id) mlic.amount, mc2.parent_charge_id, mlrs.installment, mlrs.loan_id
                           FROM m_loan_installment_charge mlic
                           JOIN m_loan_repayment_schedule mlrs ON mlrs.id = mlic.loan_schedule_id
                           JOIN m_loan_charge mlc2 ON mlc2.id = mlic.loan_charge_id
                           JOIN m_charge mc2 ON mc2.id = mlc2.charge_id AND mc2.charge_calculation_enum = 342
                            order by mlc2.id, mlrs.installment) vat_chg
                ON vat_chg.parent_charge_id = mc.id AND vat_chg.loan_id = ml.id
                where mc.charge_calculation_enum IN (468, 575, 231)
                AND (mc.insurance_company = '${insurerNit}' OR '${insurerNit}' = '-1')
                AND (mc.insurance_code = '${mandatoryInsuranceCode}' OR '${mandatoryInsuranceCode}' = '-1')
                AND ml.submittedon_date BETWEEN '${startDate}' AND '${endDate}'

                 ]]>
            </column>
            <where>report_name = 'Colocaciones o Ventas de Seguros Obligatorios'</where>
        </update>

        <insert tableName="STRETCHY_REPORT">
            <column name="REPORT_NAME" value="Ventas de Seguros y Asistencias Voluntarias"/>
            <column name="REPORT_SQL">
                <![CDATA[
                SELECT cce."NIT" AS "Nit de empresa",
                    TO_CHAR(ml.submittedon_date, 'DD/MM/YYYY') AS "Fecha de creación del crédito",
                    CASE
                        WHEN c.legal_form_enum = 2 THEN c.fullname
                        ELSE c.firstname
                    END AS "Nombre del cliente",
                    c.lastname AS "Apellidos del cliente",
                    TO_CHAR(c.date_of_birth, 'DD/MM/YYYY') AS "Fecha de Nacimiento del cliente",
                    ml.account_no AS "Número del crédito",
                    ml.term_frequency AS "Plazo del crédito",
                    ml.principal_amount AS "Valor del crédito (capital inicial)",
                    (COALESCE(insurance_chg.amount, 0) + COALESCE(vat_chg.amount, 0)) AS "Valor mensual del seguro",
                    COALESCE(insurance_chg.amount, 0) AS "Valor de la base del seguro",
                    COALESCE(vat_chg.amount, 0) AS "Valor del IVA del seguro",
                    mc.insurance_code AS "Código del seguro obligatorio",
                    mc.insurance_company AS "Nit aseguradora", mc.charge_calculation_enum
                FROM m_client c
                JOIN m_loan ml ON ml.client_id = c.id
                JOIN m_loan_charge mlc ON mlc.loan_id = ml.id
                JOIN m_charge mc ON mc.id = mlc.charge_id
                LEFT JOIN campos_cliente_empresas cce ON cce.client_id = c.id
                JOIN (SELECT distinct on (mlc2.id) mlic.amount, mlic.loan_charge_id, mlrs.installment, mlrs.loan_id
                      FROM m_loan_installment_charge mlic
                      JOIN m_loan_repayment_schedule mlrs ON mlrs.id = mlic.loan_schedule_id
                        JOIN m_loan_charge mlc2 on mlc2.id = mlic.loan_charge_id
                        where mlc2.charge_calculation_enum = 1034
                        order by mlc2.id, mlrs.installment) insurance_chg
                ON insurance_chg.loan_charge_id = mlc.id AND insurance_chg.loan_id = ml.id
                LEFT JOIN (SELECT distinct on (mlc2.id) mlic.amount, mc2.parent_charge_id, mlrs.installment, mlrs.loan_id
                           FROM m_loan_installment_charge mlic
                           JOIN m_loan_repayment_schedule mlrs ON mlrs.id = mlic.loan_schedule_id
                           JOIN m_loan_charge mlc2 ON mlc2.id = mlic.loan_charge_id
                           JOIN m_charge mc2 ON mc2.id = mlc2.charge_id AND mc2.charge_calculation_enum = 342
                            order by mlc2.id, mlrs.installment) vat_chg
                ON vat_chg.parent_charge_id = mc.id AND vat_chg.loan_id = ml.id
                WHERE mc.charge_calculation_enum IN (1034)
                AND (mc.insurance_company = '${insurerNit}' OR '${insurerNit}' = '-1')
                AND (mc.insurance_code = '${mandatoryInsuranceCode}' OR '${mandatoryInsuranceCode}' = '-1')
                AND ml.submittedon_date BETWEEN '${startDate}' AND '${endDate}'
                ]]>
            </column>
            <column name="report_type" value="Table"/>
            <column name="report_category" value="Loan"/>
            <column name="description" value="Reporte de Ventas de Seguros y Asistencias Voluntarias"/>
            <column name="core_report" value="false"/>
            <column name="use_report" value="true"/>
        </insert>

        <insert tableName="stretchy_report_parameter">
            <column name="report_id"
                    valueComputed="(select id from stretchy_report where report_name = 'Ventas de Seguros y Asistencias Voluntarias')"/>
            <column name="parameter_id"
                    valueComputed="(select id from stretchy_parameter where parameter_variable  = 'startDate')"/>
            <column name="report_parameter_name" value="startDate"/>
            <column name="mandatory_parameter" value="true"/>
        </insert>
        <insert tableName="stretchy_report_parameter">
            <column name="report_id"
                    valueComputed="(select id from stretchy_report where report_name = 'Ventas de Seguros y Asistencias Voluntarias')"/>
            <column name="parameter_id"
                    valueComputed="(select id from stretchy_parameter where parameter_variable  = 'endDate')"/>
            <column name="report_parameter_name" value="endDate"/>
            <column name="mandatory_parameter" value="true"/>
        </insert>

        <insert tableName="stretchy_report_parameter">
            <column name="report_id"
                    valueComputed="(select id from stretchy_report where report_name = 'Ventas de Seguros y Asistencias Voluntarias')"/>
            <column name="parameter_id"
                    valueComputed="(select id from stretchy_parameter where parameter_variable  = 'insurerNit')"/>
            <column name="report_parameter_name" value="insurerNit"/>
        </insert>
        <insert tableName="stretchy_report_parameter">
            <column name="report_id"
                    valueComputed="(select id from stretchy_report where report_name = 'Ventas de Seguros y Asistencias Voluntarias')"/>
            <column name="parameter_id"
                    valueComputed="(select id from stretchy_parameter where parameter_variable  = 'mandatoryInsuranceCode')"/>
            <column name="report_parameter_name" value="mandatoryInsuranceCode"/>
        </insert>
    </changeSet>


</databaseChangeLog>
