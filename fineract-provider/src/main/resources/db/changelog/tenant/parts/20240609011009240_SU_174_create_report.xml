<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.1.xsd">

    <changeSet id="1" author="fineract">
        <delete tableName="stretchy_report_parameter">
            <where>report_id = (select id from stretchy_report where report_name = 'Novedades de Seguros o Asistencias Voluntarias')</where>
        </delete>
        <delete tableName="STRETCHY_REPORT">
            <where>REPORT_NAME='Novedades de Seguros o Asistencias Voluntarias'</where>
        </delete>

        <insert tableName="STRETCHY_REPORT">
            <column name="REPORT_NAME" value="Novedades de Seguros o Asistencias Voluntarias"/>
            <column name="REPORT_SQL">
                <![CDATA[
        SELECT DISTINCT ON (min.novelty_id)
            COALESCE(cce."NIT" , '800139398-6') AS "Nit de empresa",
            TO_CHAR(min.novelty_date, 'DD/MM/YYYY') AS "Fecha de la novedad",
            mi.name AS "Tipo de novedad",
            min.novelty_id AS "Código de la novedad",
            CASE
                WHEN c.legal_form_enum = 2 THEN 'NIT'
                ELSE 'Cédula'
            END AS "Tipo de documento del cliente",
            COALESCE(cce."NIT", ccp."Cedula" ) AS "Número de documento de identidad del cliente",
            c.fullname AS "Nombre del cliente de la novedad",
            COALESCE(c.lastname, '-') AS "Apellidos del cliente de la novedad",
            mc.insurance_code AS "Código del seguro o asistencia",
            mc.insurance_plan AS "Plan",
            (COALESCE(insurance_chg.amount, 0) + COALESCE(vat_chg.amount, 0)) AS "Valor del seguro o asistencia",
            COALESCE(insurance_chg.amount, 0) AS "Base del seguro o asistencia",
            COALESCE(vat_chg.amount, 0) AS "Iva del seguro o asistencia",
            ml.account_no AS "Número del crédito",
            ml.loan_officer_id AS "Código del asesor que vendió el seguro o la asistencia",
            mc.insurance_company AS "Nit aseguradora"
        FROM
            m_client c
        JOIN m_loan ml ON ml.client_id = c.id
        JOIN m_loan_charge mlc ON mlc.loan_id = ml.id
        JOIN m_charge mc ON mc.id = mlc.charge_id
        JOIN m_insurance_novelty_news min ON min.loan_id = ml.id AND min.loan_charge_id = mlc.id
        JOIN m_insurance_incidents mi ON mi.id = min.novelty_id
        LEFT JOIN campos_cliente_empresas cce ON cce.client_id = c.id
        LEFT JOIN campos_cliente_persona ccp ON ccp.client_id = c.id
        LEFT JOIN (
            SELECT mlc2.id AS loan_charge_id, mlc2.loan_id, mlic.amount
            FROM m_loan_installment_charge mlic
            JOIN m_loan_charge mlc2 ON mlc2.id = mlic.loan_charge_id
            WHERE mlc2.charge_calculation_enum IN (1034, 468)
        ) insurance_chg ON insurance_chg.loan_charge_id = mlc.id AND insurance_chg.loan_id = ml.id
        LEFT JOIN (
            SELECT mlc2.id AS loan_charge_id, mlc2.loan_id, mlic.amount
            FROM m_loan_installment_charge mlic
            JOIN m_loan_charge mlc2 ON mlc2.id = mlic.loan_charge_id
            JOIN m_charge mc2 ON mc2.id = mlc2.charge_id AND mc2.charge_calculation_enum = 342
        ) vat_chg ON vat_chg.loan_charge_id = mlc.id AND vat_chg.loan_id = ml.id
        WHERE
            mc.charge_calculation_enum IN (1034, 468)
            AND (mc.insurance_company = '${voluntaryInsurerNit}' OR '${voluntaryInsurerNit}' = '-1')
            AND (mc.insurance_code = '${voluntaryInsuranceCode}' OR '${voluntaryInsuranceCode}' = '-1')
            AND min.novelty_date BETWEEN '${startDate}' AND '${endDate}'
        ORDER BY
            min.novelty_id, min.novelty_date DESC, ml.account_no
        ]]>
            </column>
            <column name="report_type" value="Table"/>
            <column name="report_category" value="Loan"/>
            <column name="description" value="Reporte de Novedades de Seguros o Asistencias Voluntarias"/>
            <column name="core_report" value="false"/>
            <column name="use_report" value="true"/>
        </insert>

        <insert tableName="stretchy_report_parameter">
            <column name="report_id" valueComputed="(select id from stretchy_report where report_name = 'Novedades de Seguros o Asistencias Voluntarias')"/>
            <column name="parameter_id" valueComputed="(select id from stretchy_parameter where parameter_variable = 'startDate')"/>
            <column name="report_parameter_name" value="startDate"/>
            <column name="mandatory_parameter" value="true"/>
        </insert>
        <insert tableName="stretchy_report_parameter">
            <column name="report_id" valueComputed="(select id from stretchy_report where report_name = 'Novedades de Seguros o Asistencias Voluntarias')"/>
            <column name="parameter_id" valueComputed="(select id from stretchy_parameter where parameter_variable = 'endDate')"/>
            <column name="report_parameter_name" value="endDate"/>
            <column name="mandatory_parameter" value="true"/>
        </insert>
        <insert tableName="stretchy_report_parameter">
            <column name="report_id" valueComputed="(select id from stretchy_report where report_name = 'Novedades de Seguros o Asistencias Voluntarias')"/>
            <column name="parameter_id" valueComputed="(select id from stretchy_parameter where parameter_variable = 'voluntaryInsurerNit')"/>
            <column name="report_parameter_name" value="voluntaryInsurerNit"/>
        </insert>
        <insert tableName="stretchy_report_parameter">
            <column name="report_id" valueComputed="(select id from stretchy_report where report_name = 'Novedades de Seguros o Asistencias Voluntarias')"/>
            <column name="parameter_id" valueComputed="(select id from stretchy_parameter where parameter_variable = 'voluntaryInsuranceCode')"/>
            <column name="report_parameter_name" value="voluntaryInsuranceCode"/>
        </insert>
    </changeSet>

</databaseChangeLog>
