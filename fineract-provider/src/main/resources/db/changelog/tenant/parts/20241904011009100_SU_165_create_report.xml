<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.1.xsd">
    <changeSet id="1" author="fineract">

        <delete tableName="stretchy_report_parameter">
            <where>report_id = (select id from stretchy_report where report_name = 'Recaudos de Seguros Obligatorios')
            </where>
        </delete>
        <delete tableName="STRETCHY_REPORT">
            <where>REPORT_NAME='Recaudos de Seguros Obligatorios'</where>
        </delete>


        <insert tableName="STRETCHY_REPORT">
            <column name="REPORT_NAME" value="Recaudos de Seguros Obligatorios"/>
            <column name="REPORT_SQL">
                <![CDATA[
SELECT COALESCE(cce."NIT", '800139398-6')                                          AS "Nit de empresa",
       TO_CHAR(ml.submittedon_date, 'DD/MM/YYYY')                                  AS "Fecha de creación del crédito",
       CASE
           WHEN c.legal_form_enum = 2 THEN c.fullname
           ELSE c.firstname
           END                                                                     AS "Nombre del cliente",
       c.lastname                                                                  AS "Apellidos del cliente",
       TO_CHAR(c.date_of_birth, 'DD/MM/YYYY')                                      AS "Fecha de Nacimiento del cliente",
       ml.account_no                                                               AS "Número del crédito",
       ml.term_frequency                                                           AS "Plazo del crédito",
       ml.principal_amount                                                         AS "Valor del crédito (capital inicial)",
       coalesce(installment_count.paid_installments, ml.term_frequency)            as "Número de seguros pagados",
       coalesce(installment_count.unpaid_installments, 0)                          as "Número de seguros pendientes",
       (COALESCE(insurance_chg.paid_amount, 0) + COALESCE(vat_chg.paid_amount, 0)) AS "Valor total pagado del seguro",
       COALESCE(insurance_chg.paid_amount, 0)                                      AS "Valor total de la base del seguro pagado",
       COALESCE(vat_chg.paid_amount, 0)                                            AS "Valor total del iva del seguro pagado",
       mc.insurance_code                                                           AS "Código del seguro obligatorio",
       mc.insurance_company                                                        AS "Nit aseguradora"
FROM m_client c
         JOIN m_loan ml ON ml.client_id = c.id
         JOIN m_loan_charge mlc ON mlc.loan_id = ml.id
         JOIN m_charge mc ON mc.id = mlc.charge_id
         LEFT JOIN campos_cliente_empresas cce ON cce.client_id = c.id
         left join(select count(case when mlic.is_paid_derived = true then mlic.id END)  as paid_installments,
                          count(case when mlic.is_paid_derived = false then mlic.id END) as unpaid_installments,
                          mlc2.id                                                           loan_charge_id,
                          mlc2.loan_id
                   from m_loan_charge mlc2
                            join m_loan_installment_charge mlic on mlic.loan_charge_id = mlc2.id
                   where mlc2.charge_calculation_enum IN (468, 575, 231)
                     and mlc2.id in (select distinct loan_charge_id
                                     from m_loan_charge_paid_by mlcpb
                                              join m_loan_transaction mlt on mlt.id = mlcpb.loan_transaction_id
                                     where mlcpb.loan_charge_id = mlc2.id
                                       and mlt.transaction_date BETWEEN '${startDate}' AND '${endDate}')
                   group by mlc2.loan_id, mlc2.id) installment_count
                  on installment_count.loan_charge_id = mlc.id AND installment_count.loan_id = ml.id
         join (select mlc2.id loan_charge_id, mlc2.loan_id, sum(mlcpb.amount) paid_amount
               from m_loan_transaction mlt
                        join m_loan_charge_paid_by mlcpb on mlcpb.loan_transaction_id = mlt.id
                        join m_loan_charge mlc2 on mlc2.id = mlcpb.loan_charge_id
               where mlc2.charge_calculation_enum IN (468, 575, 231)
                 and mlt.transaction_date BETWEEN '${startDate}' AND '${endDate}'
               group by mlc2.loan_id, mlc2.id) insurance_chg
              ON insurance_chg.loan_charge_id = mlc.id AND insurance_chg.loan_id = ml.id
         LEFT JOIN (SELECT sum(mlcpb.amount) paid_amount, mc2.parent_charge_id, mlc2.loan_id
                    from m_loan_transaction mlt
                             join m_loan_charge_paid_by mlcpb on mlcpb.loan_transaction_id = mlt.id
                             JOIN m_loan_charge mlc2 ON mlc2.id = mlcpb.loan_charge_id
                             JOIN m_charge mc2 ON mc2.id = mlc2.charge_id AND mc2.charge_calculation_enum = 342
                    where mlt.transaction_date BETWEEN '${startDate}' AND '${endDate}'
                    group by mlc2.loan_id, mc2.parent_charge_id) vat_chg
                   ON vat_chg.parent_charge_id = mc.id AND vat_chg.loan_id = ml.id
        where mc.charge_calculation_enum IN (468, 575, 231)
          AND (mc.insurance_company = '${insurerNit}' OR '${insurerNit}' = '-1')
          AND (mc.insurance_code = '${mandatoryInsuranceCode}' OR '${mandatoryInsuranceCode}' = '-1')
                ]]>
            </column>
            <column name="report_type" value="Table"/>
            <column name="report_category" value="Loan"/>
            <column name="description" value="Reporte de Recaudos de Seguros Obligatorios"/>
            <column name="core_report" value="false"/>
            <column name="use_report" value="true"/>
        </insert>

        <insert tableName="stretchy_report_parameter">
            <column name="report_id"
                    valueComputed="(select id from stretchy_report where report_name = 'Recaudos de Seguros Obligatorios')"/>
            <column name="parameter_id"
                    valueComputed="(select id from stretchy_parameter where parameter_variable  = 'startDate')"/>
            <column name="report_parameter_name" value="startDate"/>
            <column name="mandatory_parameter" value="true"/>
        </insert>
        <insert tableName="stretchy_report_parameter">
            <column name="report_id"
                    valueComputed="(select id from stretchy_report where report_name = 'Recaudos de Seguros Obligatorios')"/>
            <column name="parameter_id"
                    valueComputed="(select id from stretchy_parameter where parameter_variable  = 'endDate')"/>
            <column name="report_parameter_name" value="endDate"/>
            <column name="mandatory_parameter" value="true"/>
        </insert>

        <insert tableName="stretchy_report_parameter">
            <column name="report_id"
                    valueComputed="(select id from stretchy_report where report_name = 'Recaudos de Seguros Obligatorios')"/>
            <column name="parameter_id"
                    valueComputed="(select id from stretchy_parameter where parameter_variable  = 'insurerNit')"/>
            <column name="report_parameter_name" value="insurerNit"/>
        </insert>
        <insert tableName="stretchy_report_parameter">
            <column name="report_id"
                    valueComputed="(select id from stretchy_report where report_name = 'Recaudos de Seguros Obligatorios')"/>
            <column name="parameter_id"
                    valueComputed="(select id from stretchy_parameter where parameter_variable  = 'mandatoryInsuranceCode')"/>
            <column name="report_parameter_name" value="mandatoryInsuranceCode"/>
        </insert>
    </changeSet>


</databaseChangeLog>
